<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Holy Bible - Offline KJV</title>
    <style>
        :root {
            --parchment: #fff9e6;
            --parchment-dark: #e8d9b5;
            --ink: #3a2c0e;
            --accent: #8b5a2b;
            --border: #d4b483;
            --highlight-yellow: rgba(255, 255, 0, 0.2);
            --highlight-blue: rgba(0, 100, 255, 0.2);
            --highlight-green: rgba(0, 150, 0, 0.2);
            --highlight-pink: rgba(255, 100, 255, 0.2);
            --highlight-purple: rgba(150, 0, 255, 0.2);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Georgia', serif;
            background: #f5f0e6;
            color: #333;
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Header */
        .header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: var(--parchment);
            border-bottom: 2px solid var(--border);
            padding: 10px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 100;
            box-shadow: 0 2px 10px rgba(139, 90, 43, 0.1);
        }

        .menu-btn {
            background: none;
            border: 2px solid var(--border);
            border-radius: 5px;
            width: 40px;
            height: 40px;
            font-size: 18px;
            color: var(--accent);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .title-container {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            flex: 1;
            min-width: 0;
        }

        .title {
            font-family: 'Uncial Antiqua', cursive;
            font-size: 18px;
            font-weight: bold;
            color: var(--accent);
            text-align: center;
            padding: 0 10px;
            cursor: pointer;
        }

        .header-btn {
            background: none;
            border: 2px solid var(--border);
            border-radius: 5px;
            width: 40px;
            height: 40px;
            font-size: 18px;
            color: var(--accent);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Sidebar Menu */
        .sidebar {
            position: fixed;
            top: 0;
            left: -280px;
            width: 280px;
            height: 100%;
            background: var(--parchment);
            border-right: 3px solid var(--border);
            z-index: 1001;
            transition: left 0.3s ease;
            overflow-y: auto;
        }

        .sidebar.active {
            left: 0;
        }

        .sidebar-header {
            padding: 20px;
            background: var(--parchment-dark);
            border-bottom: 2px solid var(--border);
            text-align: center;
        }

        .sidebar-title {
            font-family: 'Uncial Antiqua', cursive;
            color: var(--accent);
            font-size: 24px;
        }

        .menu-items {
            padding: 20px 0;
        }

        .menu-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px 25px;
            color: var(--ink);
            text-decoration: none;
            border-bottom: 1px solid var(--border);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .menu-item:hover {
            background: rgba(139, 90, 43, 0.1);
            padding-left: 30px;
        }

        .menu-item i {
            width: 20px;
            color: var(--accent);
            font-size: 18px;
        }

        /* Main Content */
        .content {
            padding: 70px 20px 70px;
            max-width: 700px;
            margin: 0 auto;
            transition: transform 0.3s ease;
        }

        .content.shifted {
            transform: translateX(280px);
        }

        /* Full Screen Screens */
        .screen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--parchment);
            z-index: 999;
            transform: translateX(100%);
            transition: transform 0.3s ease;
            overflow-y: auto;
            padding: 70px 20px 20px;
        }

        .screen.active {
            transform: translateX(0);
        }

        .screen-header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: var(--parchment);
            border-bottom: 2px solid var(--border);
            padding: 15px;
            display: flex;
            align-items: center;
            gap: 15px;
            z-index: 1000;
        }

        .screen-back-btn {
            background: none;
            border: 2px solid var(--border);
            border-radius: 5px;
            width: 40px;
            height: 40px;
            font-size: 18px;
            color: var(--accent);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .screen-title {
            font-family: 'Uncial Antiqua', cursive;
            font-size: 20px;
            color: var(--accent);
            flex: 1;
        }

        .screen-content {
            padding: 20px;
            max-width: 700px;
            margin: 0 auto;
        }

        /* Verse Styling */
        .verse {
            margin-bottom: 20px;
            position: relative;
            padding-left: 45px;
            line-height: 1.8;
            padding: 15px;
            padding-left: 55px;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 8px;
            border-left: 3px solid var(--accent);
            box-shadow: 0 2px 5px rgba(139, 90, 43, 0.1);
        }

        .verse-number {
            position: absolute;
            left: 15px;
            top: 15px;
            font-size: 14px;
            color: var(--accent);
            font-weight: bold;
            background: var(--parchment);
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid var(--border);
        }

        .verse-text {
            display: block;
            font-size: 18px;
            color: var(--ink);
        }

        /* Highlight Classes */
        .highlight-yellow { background-color: var(--highlight-yellow) !important; }
        .highlight-blue { background-color: var(--highlight-blue) !important; }
        .highlight-green { background-color: var(--highlight-green) !important; }
        .highlight-pink { background-color: var(--highlight-pink) !important; }
        .highlight-purple { background-color: var(--highlight-purple) !important; }
        .underlined { text-decoration: underline 2px var(--accent); }
        .italicized { font-style: italic; }
        .bold { font-weight: bold; }

        /* Loading */
        .loading {
            text-align: center;
            padding: 40px 20px;
            color: var(--accent);
        }

        .spinner {
            display: inline-block;
            width: 30px;
            height: 30px;
            border: 3px solid var(--border);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 15px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Skeleton Loading */
        .skeleton {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
            border-radius: 4px;
            margin: 10px 0;
        }

        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 10px;
            width: 90%;
            max-width: 400px;
            max-height: 80vh;
            overflow: hidden;
            border: 3px solid var(--border);
        }

        .modal-header {
            background: var(--parchment);
            padding: 15px;
            border-bottom: 2px solid var(--border);
            font-weight: bold;
            color: var(--accent);
            text-align: center;
            font-family: 'Uncial Antiqua', cursive;
            font-size: 20px;
        }

        .modal-body {
            padding: 20px;
            max-height: 60vh;
            overflow-y: auto;
        }

        .modal-close {
            position: absolute;
            right: 15px;
            top: 15px;
            background: none;
            border: none;
            font-size: 20px;
            color: var(--accent);
            cursor: pointer;
        }

        /* Book Selection */
        .testament-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            justify-content: center;
        }

        .tab {
            padding: 8px 15px;
            border: 1px solid var(--border);
            background: white;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
        }

        .tab.active {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
        }

        .book-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
        }

        .book-item {
            padding: 12px 5px;
            text-align: center;
            border: 1px solid var(--border);
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            background: rgba(255, 255, 255, 0.8);
        }

        .book-item:hover {
            background: var(--accent);
            color: white;
        }

        /* Verse Actions Modal */
        .verse-actions {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }

        .action-btn {
            padding: 12px 8px;
            border: 2px solid var(--border);
            background: rgba(255, 255, 255, 0.8);
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
            font-size: 12px;
            color: var(--accent);
        }

        .action-btn:hover {
            background: var(--accent);
            color: white;
        }

        .highlight-options {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 8px;
            margin: 15px 0;
        }

        .highlight-btn {
            width: 35px;
            height: 35px;
            border-radius: 6px;
            border: 2px solid var(--border);
            cursor: pointer;
        }

        .highlight-btn.active {
            transform: scale(1.1);
            box-shadow: 0 3px 8px rgba(0,0,0,0.2);
        }

        .highlight-btn.yellow { background-color: var(--highlight-yellow); }
        .highlight-btn.blue { background-color: var(--highlight-blue); }
        .highlight-btn.green { background-color: var(--highlight-green); }
        .highlight-btn.pink { background-color: var(--highlight-pink); }
        .highlight-btn.purple { background-color: var(--highlight-purple); }

        .note-input {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-family: inherit;
            font-size: 14px;
            resize: vertical;
            min-height: 80px;
            margin-top: 15px;
            background: rgba(255, 255, 255, 0.9);
        }

        /* Notebook Styling */
        .notebook-page {
            background: white;
            border: 2px solid var(--border);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 3px 10px rgba(139, 90, 43, 0.1);
            position: relative;
            min-height: 150px;
        }

        .notebook-page::before {
            content: '';
            position: absolute;
            left: 40px;
            top: 0;
            bottom: 0;
            width: 2px;
            background: repeating-linear-gradient(
                to bottom,
                transparent,
                transparent 20px,
                var(--border) 20px,
                var(--border) 21px
            );
        }

        .note-title {
            font-family: 'Uncial Antiqua', cursive;
            font-size: 20px;
            color: var(--accent);
            margin-bottom: 15px;
            padding-left: 50px;
            border-bottom: 2px solid var(--border);
            padding-bottom: 8px;
        }

        .note-content {
            padding-left: 50px;
            line-height: 1.8;
            color: var(--ink);
            font-size: 16px;
            white-space: pre-wrap;
        }

        .note-reference {
            color: var(--accent);
            font-weight: bold;
            margin-bottom: 10px;
            padding-left: 50px;
            font-size: 14px;
        }

        .note-date {
            color: #888;
            font-size: 12px;
            padding-left: 50px;
            margin-top: 15px;
        }

        /* Search */
        .search-input {
            width: 100%;
            padding: 10px;
            margin-bottom: 15px;
            border: 2px solid var(--border);
            border-radius: 5px;
            font-size: 14px;
        }

        .search-results {
            max-height: 300px;
            overflow-y: auto;
        }

        .search-result {
            padding: 10px;
            border-bottom: 1px solid var(--border);
            cursor: pointer;
        }

        .search-result:hover {
            background: rgba(139, 90, 43, 0.1);
        }

        /* Settings */
        .settings-group {
            margin-bottom: 20px;
        }

        .settings-label {
            display: block;
            margin-bottom: 8px;
            color: var(--accent);
            font-weight: bold;
        }

        .font-slider {
            width: 100%;
            height: 6px;
            -webkit-appearance: none;
            appearance: none;
            background: var(--border);
            border-radius: 3px;
            outline: none;
        }

        .font-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--accent);
            cursor: pointer;
        }

        .font-size-display {
            text-align: center;
            margin-top: 8px;
            font-weight: bold;
            color: var(--accent);
        }

        /* Toast */
        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: white;
            border: 2px solid var(--accent);
            padding: 10px 20px;
            border-radius: 5px;
            box-shadow: 0 4px 12px rgba(139, 90, 43, 0.2);
            opacity: 0;
            transition: all 0.3s ease;
            z-index: 1001;
        }

        .toast.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }

        /* Navigation Hint */
        .nav-hint {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--parchment);
            border: 2px solid var(--border);
            border-radius: 20px;
            padding: 8px 16px;
            font-size: 12px;
            color: var(--accent);
            z-index: 90;
            opacity: 0.8;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 0.8; }
            50% { opacity: 1; }
        }

        /* Responsive */
        @media (max-width: 600px) {
            .content {
                padding: 70px 15px 70px;
            }
            
            .verse {
                padding: 12px;
                padding-left: 50px;
                font-size: 16px;
            }
            
            .verse-number {
                width: 25px;
                height: 25px;
                font-size: 12px;
            }
            
            .book-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .verse-actions {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .notebook-page {
                padding: 15px;
            }
            
            .notebook-page::before {
                left: 30px;
            }
            
            .note-title, .note-content, .note-reference, .note-date {
                padding-left: 40px;
            }
        }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Uncial+Antiqua&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <!-- Header -->
    <div class="header">
        <button class="menu-btn" id="menuBtn">
            <i class="fas fa-bars"></i>
        </button>
        <div class="title-container">
            <div class="title" id="currentRef">
                <i class="fas fa-book-bible"></i> Genesis 1
            </div>
        </div>
        <button class="header-btn" id="searchBtn">
            <i class="fas fa-search"></i>
        </button>
    </div>

    <!-- Sidebar Menu -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <div class="sidebar-title">
                <i class="fas fa-bible"></i> Holy Bible
            </div>
        </div>
        <div class="menu-items">
            <div class="menu-item" onclick="openBookSelection()">
                <i class="fas fa-book-open"></i>
                <span>Books</span>
            </div>
            <div class="menu-item" onclick="openNotebookScreen()">
                <i class="fas fa-book"></i>
                <span>Notebook</span>
            </div>
            <div class="menu-item" onclick="openHighlightsScreen()">
                <i class="fas fa-highlighter"></i>
                <span>Highlights</span>
            </div>
            <div class="menu-item" onclick="openSettingsScreen()">
                <i class="fas fa-cog"></i>
                <span>Settings</span>
            </div>
            <div class="menu-item" onclick="openAboutScreen()">
                <i class="fas fa-info-circle"></i>
                <span>About</span>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="content" id="mainContent">
        <div id="bibleContent">
            <div class="loading">
                <div class="spinner"></div>
                <p>Loading Bible...</p>
            </div>
        </div>
    </div>

    <!-- Navigation Hint -->
    <div class="nav-hint" id="navHint">
        <i class="fas fa-arrows-left-right"></i> Swipe left/right to navigate chapters
    </div>

    <!-- Full Screen Screens -->
    <!-- Notebook Screen -->
    <div class="screen" id="notebookScreen">
        <div class="screen-header">
            <button class="screen-back-btn" onclick="closeScreen('notebookScreen')">
                <i class="fas fa-arrow-left"></i>
            </button>
            <div class="screen-title">
                <i class="fas fa-book"></i> My Notebook
            </div>
        </div>
        <div class="screen-content" id="notebookContent">
            <!-- Notebook content will be loaded here -->
        </div>
    </div>

    <!-- Highlights Screen -->
    <div class="screen" id="highlightsScreen">
        <div class="screen-header">
            <button class="screen-back-btn" onclick="closeScreen('highlightsScreen')">
                <i class="fas fa-arrow-left"></i>
            </button>
            <div class="screen-title">
                <i class="fas fa-highlighter"></i> My Highlights
            </div>
        </div>
        <div class="screen-content" id="highlightsContent">
            <!-- Highlights content will be loaded here -->
        </div>
    </div>

    <!-- Settings Screen -->
    <div class="screen" id="settingsScreen">
        <div class="screen-header">
            <button class="screen-back-btn" onclick="closeScreen('settingsScreen')">
                <i class="fas fa-arrow-left"></i>
            </button>
            <div class="screen-title">
                <i class="fas fa-cog"></i> Settings
            </div>
        </div>
        <div class="screen-content">
            <div class="settings-group">
                <label class="settings-label">Font Size</label>
                <input type="range" min="14" max="24" value="18" class="font-slider" id="fontSizeSlider" 
                       oninput="updateFontSize(this.value)">
                <div class="font-size-display" id="fontSizeDisplay">18px</div>
            </div>
            
            <div class="settings-group">
                <label class="settings-label">Line Height</label>
                <input type="range" min="1.4" max="2.2" step="0.1" value="1.8" class="font-slider" id="lineHeightSlider" 
                       oninput="updateLineHeight(this.value)">
                <div class="font-size-display" id="lineHeightDisplay">1.8</div>
            </div>
            
            <div class="settings-group">
                <button class="action-btn" style="width: 100%; padding: 15px;" onclick="clearCache()">
                    <i class="fas fa-trash"></i> Clear Cache
                </button>
            </div>
        </div>
    </div>

    <!-- About Screen -->
    <div class="screen" id="aboutScreen">
        <div class="screen-header">
            <button class="screen-back-btn" onclick="closeScreen('aboutScreen')">
                <i class="fas fa-arrow-left"></i>
            </button>
            <div class="screen-title">
                <i class="fas fa-info-circle"></i> About
            </div>
        </div>
        <div class="screen-content">
            <div style="text-align: center; margin-bottom: 20px;">
                <i class="fas fa-bible" style="font-size: 36px; color: var(--accent);"></i>
                <h2 style="color: var(--accent); margin: 10px 0;">Holy Bible Reader</h2>
                <p>King James Version</p>
                <p><small>Offline Version - Works without internet</small></p>
            </div>
            <div style="border-top: 2px solid var(--border); padding-top: 15px;">
                <p style="font-style: italic; color: var(--accent);">
                    "Thy word is a lamp unto my feet, and a light unto my path."<br>
                    - Psalm 119:105
                </p>
            </div>
        </div>
    </div>

    <!-- Book Selection Modal -->
    <div class="modal" id="bookModal">
        <div class="modal-content">
            <div class="modal-header">
                <span><i class="fas fa-book-open"></i> Select Book</span>
                <button class="modal-close" onclick="closeModal('bookModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="testament-tabs">
                    <div class="tab active" onclick="filterBooks('all')">All</div>
                    <div class="tab" onclick="filterBooks('old')">Old</div>
                    <div class="tab" onclick="filterBooks('new')">New</div>
                </div>
                <div class="book-grid" id="bookList">
                    <!-- Books will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Chapter Selection Modal -->
    <div class="modal" id="chapterModal">
        <div class="modal-content">
            <div class="modal-header">
                <span id="chapterTitle"><i class="fas fa-list-ol"></i> Select Chapter</span>
                <button class="modal-close" onclick="closeModal('chapterModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="book-grid" id="chapterList">
                    <!-- Chapters will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Verse Actions Modal -->
    <div class="modal" id="verseModal">
        <div class="modal-content">
            <div class="modal-header">
                <span id="verseTitle"><i class="fas fa-edit"></i> Verse Options</span>
                <button class="modal-close" onclick="closeModal('verseModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="verse-actions">
                    <button class="action-btn" onclick="addNote()">
                        <i class="fas fa-sticky-note"></i>
                        <span>Note</span>
                    </button>
                    <button class="action-btn" onclick="toggleUnderline()">
                        <i class="fas fa-underline"></i>
                        <span>Underline</span>
                    </button>
                    <button class="action-btn" onclick="toggleItalic()">
                        <i class="fas fa-italic"></i>
                        <span>Italic</span>
                    </button>
                    <button class="action-btn" onclick="toggleBold()">
                        <i class="fas fa-bold"></i>
                        <span>Bold</span>
                    </button>
                    <button class="action-btn" onclick="copyVerse()">
                        <i class="fas fa-copy"></i>
                        <span>Copy</span>
                    </button>
                    <button class="action-btn" onclick="shareVerse()">
                        <i class="fas fa-share"></i>
                        <span>Share</span>
                    </button>
                </div>
                
                <div style="margin: 15px 0;">
                    <div style="font-weight: bold; color: var(--accent); margin-bottom: 8px;">Highlight:</div>
                    <div class="highlight-options">
                        <div class="highlight-btn yellow" onclick="applyHighlight('yellow')"></div>
                        <div class="highlight-btn blue" onclick="applyHighlight('blue')"></div>
                        <div class="highlight-btn green" onclick="applyHighlight('green')"></div>
                        <div class="highlight-btn pink" onclick="applyHighlight('pink')"></div>
                        <div class="highlight-btn purple" onclick="applyHighlight('purple')"></div>
                    </div>
                </div>
                
                <textarea class="note-input" id="verseNote" placeholder="Add a note for this verse..."></textarea>
                <button class="action-btn" style="width: 100%; padding: 15px; margin-top: 15px;" onclick="saveVerseData()">
                    <i class="fas fa-save"></i> Save Changes
                </button>
            </div>
        </div>
    </div>

    <!-- Search Modal -->
    <div class="modal" id="searchModal">
        <div class="modal-content">
            <div class="modal-header">
                <span><i class="fas fa-search"></i> Search Bible</span>
                <button class="modal-close" onclick="closeModal('searchModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <input type="text" class="search-input" id="searchInput" 
                       placeholder="Search for words or phrases..." 
                       oninput="performSearch()">
                <div class="search-results" id="searchResults">
                    <div style="text-align: center; padding: 30px; color: var(--accent);">
                        <i class="fas fa-search" style="font-size: 24px; margin-bottom: 10px;"></i>
                        <p>Enter search terms above</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast -->
    <div class="toast" id="toast">
        <i class="fas fa-check-circle"></i>
        <span id="toastMessage">Action completed</span>
    </div>

    <script>
        // ========== STATE MANAGEMENT ==========
        const state = {
            currentBook: 'genesis',
            currentBookName: 'Genesis',
            currentChapter: 1,
            selectedVerseKey: null,
            isLoading: false,
            bibleData: null, // Will hold the loaded Bible data
            highlights: JSON.parse(localStorage.getItem('bibleHighlights') || '{}'),
            notes: JSON.parse(localStorage.getItem('bibleNotes') || '{}'),
            settings: JSON.parse(localStorage.getItem('bibleSettings') || '{}'),
            books: {
                old: [
                    {id: 'genesis', name: 'Genesis', chapters: 50},
                    {id: 'exodus', name: 'Exodus', chapters: 40},
                    {id: 'leviticus', name: 'Leviticus', chapters: 27},
                    {id: 'numbers', name: 'Numbers', chapters: 36},
                    {id: 'deuteronomy', name: 'Deuteronomy', chapters: 34},
                    {id: 'joshua', name: 'Joshua', chapters: 24},
                    {id: 'judges', name: 'Judges', chapters: 21},
                    {id: 'ruth', name: 'Ruth', chapters: 4},
                    {id: '1 samuel', name: '1 Samuel', chapters: 31},
                    {id: '2 samuel', name: '2 Samuel', chapters: 24},
                    {id: '1 kings', name: '1 Kings', chapters: 22},
                    {id: '2 kings', name: '2 Kings', chapters: 25},
                    {id: '1 chronicles', name: '1 Chronicles', chapters: 29},
                    {id: '2 chronicles', name: '2 Chronicles', chapters: 36},
                    {id: 'ezra', name: 'Ezra', chapters: 10},
                    {id: 'nehemiah', name: 'Nehemiah', chapters: 13},
                    {id: 'esther', name: 'Esther', chapters: 10},
                    {id: 'job', name: 'Job', chapters: 42},
                    {id: 'psalms', name: 'Psalms', chapters: 150},
                    {id: 'proverbs', name: 'Proverbs', chapters: 31},
                    {id: 'ecclesiastes', name: 'Ecclesiastes', chapters: 12},
                    {id: 'song of solomon', name: 'Song of Solomon', chapters: 8},
                    {id: 'isaiah', name: 'Isaiah', chapters: 66},
                    {id: 'jeremiah', name: 'Jeremiah', chapters: 52},
                    {id: 'lamentations', name: 'Lamentations', chapters: 5},
                    {id: 'ezekiel', name: 'Ezekiel', chapters: 48},
                    {id: 'daniel', name: 'Daniel', chapters: 12},
                    {id: 'hosea', name: 'Hosea', chapters: 14},
                    {id: 'joel', name: 'Joel', chapters: 3},
                    {id: 'amos', name: 'Amos', chapters: 9},
                    {id: 'obadiah', name: 'Obadiah', chapters: 1},
                    {id: 'jonah', name: 'Jonah', chapters: 4},
                    {id: 'micah', name: 'Micah', chapters: 7},
                    {id: 'nahum', name: 'Nahum', chapters: 3},
                    {id: 'habakkuk', name: 'Habakkuk', chapters: 3},
                    {id: 'zephaniah', name: 'Zephaniah', chapters: 3},
                    {id: 'haggai', name: 'Haggai', chapters: 2},
                    {id: 'zechariah', name: 'Zechariah', chapters: 14},
                    {id: 'malachi', name: 'Malachi', chapters: 4}
                ],
                new: [
                    {id: 'matthew', name: 'Matthew', chapters: 28},
                    {id: 'mark', name: 'Mark', chapters: 16},
                    {id: 'luke', name: 'Luke', chapters: 24},
                    {id: 'john', name: 'John', chapters: 21},
                    {id: 'acts', name: 'Acts', chapters: 28},
                    {id: 'romans', name: 'Romans', chapters: 16},
                    {id: '1 corinthians', name: '1 Corinthians', chapters: 16},
                    {id: '2 corinthians', name: '2 Corinthians', chapters: 13},
                    {id: 'galatians', name: 'Galatians', chapters: 6},
                    {id: 'ephesians', name: 'Ephesians', chapters: 6},
                    {id: 'philippians', name: 'Philippians', chapters: 4},
                    {id: 'colossians', name: 'Colossians', chapters: 4},
                    {id: '1 thessalonians', name: '1 Thessalonians', chapters: 5},
                    {id: '2 thessalonians', name: '2 Thessalonians', chapters: 3},
                    {id: '1 timothy', name: '1 Timothy', chapters: 6},
                    {id: '2 timothy', name: '2 Timothy', chapters: 4},
                    {id: 'titus', name: 'Titus', chapters: 3},
                    {id: 'philemon', name: 'Philemon', chapters: 1},
                    {id: 'hebrews', name: 'Hebrews', chapters: 13},
                    {id: 'james', name: 'James', chapters: 5},
                    {id: '1 peter', name: '1 Peter', chapters: 5},
                    {id: '2 peter', name: '2 Peter', chapters: 3},
                    {id: '1 john', name: '1 John', chapters: 5},
                    {id: '2 john', name: '2 John', chapters: 1},
                    {id: '3 john', name: '3 John', chapters: 1},
                    {id: 'jude', name: 'Jude', chapters: 1},
                    {id: 'revelation', name: 'Revelation', chapters: 22}
                ]
            }
        };

        // ========== BIBLE DATA LOADING ==========
        async function loadBibleData() {
            try {
                // Load the Bible JSON file
                const response = await fetch('bible.json');
                if (!response.ok) {
                    throw new Error('Failed to load Bible data');
                }
                
                state.bibleData = await response.json();
                console.log('Bible data loaded successfully');
                
                // Load the first chapter
                loadChapter('genesis', 1);
                
            } catch (error) {
                console.error('Error loading Bible data:', error);
                document.getElementById('bibleContent').innerHTML = `
                    <div class="loading">
                        <div style="color: #dc2626; margin-bottom: 10px;">⚠️</div>
                        <h3 style="color: var(--accent); margin-bottom: 10px;">Error Loading Bible</h3>
                        <p>Failed to load Bible data. Please ensure bible.json is in the same directory.</p>
                        <button class="action-btn" onclick="loadBibleData()" style="margin-top: 10px; padding: 10px;">
                            <i class="fas fa-redo"></i> Retry
                        </button>
                    </div>
                `;
            }
        }

        // ========== CHAPTER LOADING ==========
        function loadChapter(book, chapter) {
            if (state.isLoading) return;
            
            state.isLoading = true;
            
            if (book && chapter) {
                state.currentBook = book;
                state.currentChapter = chapter;
                const allBooks = [...state.books.old, ...state.books.new];
                const bookInfo = allBooks.find(b => b.id === book);
                if (bookInfo) state.currentBookName = bookInfo.name;
            }
            
            document.getElementById('currentRef').innerHTML = 
                `<i class="fas fa-book-bible"></i> ${state.currentBookName} ${state.currentChapter}`;
            
            try {
                if (!state.bibleData) {
                    throw new Error('Bible data not loaded');
                }
                
                // Get the book data from bible.json
                const bookData = state.bibleData[state.currentBook];
                if (!bookData) {
                    throw new Error(`Book ${state.currentBook} not found in data`);
                }
                
                // Get the chapter data
                const chapterData = bookData[state.currentChapter.toString()];
                if (!chapterData) {
                    throw new Error(`Chapter ${state.currentChapter} not found`);
                }
                
                // Display the verses
                displayVerses(chapterData);
                showToast(`Loaded ${state.currentBookName} ${state.currentChapter}`);
                
            } catch (error) {
                console.error('Failed to load chapter:', error);
                document.getElementById('bibleContent').innerHTML = `
                    <div class="loading">
                        <div style="color: #dc2626; margin-bottom: 10px;">⚠️</div>
                        <p>Failed to load chapter</p>
                        <p style="font-size: 14px; color: #666;">${error.message}</p>
                        <button class="action-btn" onclick="retryLoad()" style="margin-top: 10px; padding: 10px;">
                            Retry
                        </button>
                    </div>
                `;
                showToast('Failed to load chapter', 3000);
            } finally {
                state.isLoading = false;
            }
        }

        function displayVerses(verses) {
            let html = '';
            
            // Check if verses is an array (your JSON structure) or object
            if (Array.isArray(verses)) {
                // If verses is an array of strings
                verses.forEach((verseText, index) => {
                    const verseNumber = index + 1;
                    const verseKey = `${state.currentBook}-${state.currentChapter}-${verseNumber}`;
                    const verseData = state.highlights[verseKey] || {};
                    const note = state.notes[verseKey] || '';
                    
                    let verseClasses = 'verse';
                    if (verseData.highlight) verseClasses += ` highlight-${verseData.highlight}`;
                    if (verseData.underline) verseClasses += ' underlined';
                    if (verseData.italic) verseClasses += ' italicized';
                    if (verseData.bold) verseClasses += ' bold';
                    
                    html += `
                        <div class="${verseClasses}" 
                             data-verse-key="${verseKey}"
                             onclick="selectVerse('${verseKey}')"
                             oncontextmenu="event.preventDefault(); openVerseActions('${verseKey}')"
                             ontouchstart="startTouch('${verseKey}')"
                             ontouchend="endTouch('${verseKey}')">
                            <span class="verse-number">${verseNumber}</span>
                            <span class="verse-text">${verseText}</span>
                            ${note ? `<div style="margin-top: 8px; font-style: italic; color: #666; font-size: 14px;">${note}</div>` : ''}
                        </div>
                    `;
                });
            } else if (typeof verses === 'object') {
                // If verses is an object with verse numbers as keys
                Object.keys(verses).forEach(verseNumber => {
                    const verseText = verses[verseNumber];
                    const verseKey = `${state.currentBook}-${state.currentChapter}-${verseNumber}`;
                    const verseData = state.highlights[verseKey] || {};
                    const note = state.notes[verseKey] || '';
                    
                    let verseClasses = 'verse';
                    if (verseData.highlight) verseClasses += ` highlight-${verseData.highlight}`;
                    if (verseData.underline) verseClasses += ' underlined';
                    if (verseData.italic) verseClasses += ' italicized';
                    if (verseData.bold) verseClasses += ' bold';
                    
                    html += `
                        <div class="${verseClasses}" 
                             data-verse-key="${verseKey}"
                             onclick="selectVerse('${verseKey}')"
                             oncontextmenu="event.preventDefault(); openVerseActions('${verseKey}')"
                             ontouchstart="startTouch('${verseKey}')"
                             ontouchend="endTouch('${verseKey}')">
                            <span class="verse-number">${verseNumber}</span>
                            <span class="verse-text">${verseText}</span>
                            ${note ? `<div style="margin-top: 8px; font-style: italic; color: #666; font-size: 14px;">${note}</div>` : ''}
                        </div>
                    `;
                });
            }
            
            document.getElementById('bibleContent').innerHTML = html;
        }

        // ========== TOUCH HANDLING ==========
        let touchTimer;
        let longPressDetected = false;

        function startTouch(verseKey) {
            longPressDetected = false;
            touchTimer = setTimeout(() => {
                longPressDetected = true;
                openVerseActions(verseKey);
            }, 500);
        }

        function endTouch(verseKey) {
            clearTimeout(touchTimer);
            if (!longPressDetected) {
                selectVerse(verseKey);
            }
        }

        // ========== SWIPE NAVIGATION ==========
        let touchStartX = 0;
        let touchStartY = 0;

        document.addEventListener('touchstart', (e) => {
            touchStartX = e.changedTouches[0].screenX;
            touchStartY = e.changedTouches[0].screenY;
        });

        document.addEventListener('touchend', (e) => {
            const touchEndX = e.changedTouches[0].screenX;
            const touchEndY = e.changedTouches[0].screenY;
            const diffX = touchStartX - touchEndX;
            const diffY = Math.abs(touchStartY - touchEndY);
            
            // Only trigger if horizontal swipe is significant and vertical movement is minimal
            if (Math.abs(diffX) > 50 && diffY < 100) {
                if (diffX > 0) {
                    nextChapter();
                } else if (diffX < 0) {
                    prevChapter();
                }
            }
        });

        // ========== NAVIGATION FUNCTIONS ==========
        function prevChapter() {
            if (state.currentChapter > 1) {
                loadChapter(state.currentBook, state.currentChapter - 1);
            }
        }

        function nextChapter() {
            const currentBook = [...state.books.old, ...state.books.new]
                .find(b => b.id === state.currentBook);
            
            if (currentBook && state.currentChapter < currentBook.chapters) {
                loadChapter(state.currentBook, state.currentChapter + 1);
            }
        }

        // ========== MODAL & SCREEN MANAGEMENT ==========
        function openScreen(screenId) {
            closeSidebar();
            document.getElementById(screenId).classList.add('active');
            document.getElementById('navHint').style.display = 'none';
        }

        function closeScreen(screenId) {
            document.getElementById(screenId).classList.remove('active');
            document.getElementById('navHint').style.display = 'block';
        }

        function openModal(modalId) {
            closeSidebar();
            closeAllModals();
            document.getElementById(modalId).classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
            document.body.style.overflow = 'auto';
        }

        function closeAllModals() {
            document.querySelectorAll('.modal').forEach(modal => {
                modal.classList.remove('active');
            });
            document.body.style.overflow = 'auto';
        }

        // ========== SIDEBAR ==========
        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('active');
            document.getElementById('mainContent').classList.toggle('shifted');
        }

        function closeSidebar() {
            document.getElementById('sidebar').classList.remove('active');
            document.getElementById('mainContent').classList.remove('shifted');
        }

        // ========== BOOK SELECTION ==========
        function openBookSelection() {
            filterBooks('all');
            openModal('bookModal');
        }

        function filterBooks(filter) {
            const bookList = document.getElementById('bookList');
            const tabs = document.querySelectorAll('.tab');
            
            tabs.forEach(tab => tab.classList.remove('active'));
            event.target.classList.add('active');
            
            let booksToShow = [];
            if (filter === 'old') {
                booksToShow = state.books.old;
            } else if (filter === 'new') {
                booksToShow = state.books.new;
            } else {
                booksToShow = [...state.books.old, ...state.books.new];
            }
            
            bookList.innerHTML = '';
            booksToShow.forEach(book => {
                const bookItem = document.createElement('div');
                bookItem.className = 'book-item';
                bookItem.textContent = book.name;
                bookItem.onclick = () => {
                    state.currentBook = book.id;
                    state.currentBookName = book.name;
                    closeModal('bookModal');
                    setTimeout(() => openChapterModal(), 300);
                };
                bookList.appendChild(bookItem);
            });
        }

        function openChapterModal() {
            const currentBook = [...state.books.old, ...state.books.new]
                .find(b => b.id === state.currentBook);
            if (!currentBook) return;
            
            document.getElementById('chapterTitle').innerHTML = 
                `<i class="fas fa-list-ol"></i> ${state.currentBookName}`;
            
            const chapterList = document.getElementById('chapterList');
            chapterList.innerHTML = '';
            
            const columns = Math.ceil(Math.sqrt(currentBook.chapters));
            chapterList.style.gridTemplateColumns = `repeat(${columns}, 1fr)`;
            
            for (let i = 1; i <= currentBook.chapters; i++) {
                const chapterItem = document.createElement('div');
                chapterItem.className = 'book-item';
                chapterItem.textContent = i;
                chapterItem.onclick = () => {
                    state.currentChapter = i;
                    closeModal('chapterModal');
                    loadChapter();
                };
                chapterList.appendChild(chapterItem);
            }
            
            openModal('chapterModal');
        }

        // ========== VERSE ACTIONS ==========
        function openVerseActions(verseKey) {
            state.selectedVerseKey = verseKey;
            const verseData = state.highlights[verseKey] || {};
            const note = state.notes[verseKey] || '';
            
            const [bookId, chapter, verse] = verseKey.split('-');
            const book = [...state.books.old, ...state.books.new].find(b => b.id === bookId);
            document.getElementById('verseTitle').innerHTML = 
                `<i class="fas fa-edit"></i> ${book?.name || 'Book'} ${chapter}:${verse}`;
            
            document.getElementById('verseNote').value = note;
            
            document.querySelectorAll('.highlight-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.classList.contains(verseData.highlight)) {
                    btn.classList.add('active');
                }
            });
            
            openModal('verseModal');
        }

        function applyHighlight(color) {
            if (!state.selectedVerseKey) return;
            
            const verseData = state.highlights[state.selectedVerseKey] || {};
            verseData.highlight = color;
            state.highlights[state.selectedVerseKey] = verseData;
            
            document.querySelectorAll('.highlight-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.classList.contains(color)) btn.classList.add('active');
            });
            
            const verseElement = document.querySelector(`[data-verse-key="${state.selectedVerseKey}"]`);
            if (verseElement) {
                verseElement.classList.remove('highlight-yellow', 'highlight-blue', 'highlight-green', 'highlight-pink', 'highlight-purple');
                verseElement.classList.add(`highlight-${color}`);
            }
            
            showToast(`Highlighted in ${color}`);
        }

        function toggleUnderline() {
            if (!state.selectedVerseKey) return;
            
            const verseData = state.highlights[state.selectedVerseKey] || {};
            verseData.underline = !verseData.underline;
            state.highlights[state.selectedVerseKey] = verseData;
            
            const verseElement = document.querySelector(`[data-verse-key="${state.selectedVerseKey}"]`);
            if (verseElement) verseElement.classList.toggle('underlined');
            
            showToast(verseData.underline ? 'Underlined' : 'Underline removed');
        }

        function toggleItalic() {
            if (!state.selectedVerseKey) return;
            
            const verseData = state.highlights[state.selectedVerseKey] || {};
            verseData.italic = !verseData.italic;
            state.highlights[state.selectedVerseKey] = verseData;
            
            const verseElement = document.querySelector(`[data-verse-key="${state.selectedVerseKey}"]`);
            if (verseElement) verseElement.classList.toggle('italicized');
            
            showToast(verseData.italic ? 'Italicized' : 'Italic removed');
        }

        function toggleBold() {
            if (!state.selectedVerseKey) return;
            
            const verseData = state.highlights[state.selectedVerseKey] || {};
            verseData.bold = !verseData.bold;
            state.highlights[state.selectedVerseKey] = verseData;
            
            const verseElement = document.querySelector(`[data-verse-key="${state.selectedVerseKey}"]`);
            if (verseElement) verseElement.classList.toggle('bold');
            
            showToast(verseData.bold ? 'Bold applied' : 'Bold removed');
        }

        function addNote() {
            document.getElementById('verseNote').focus();
        }

        function copyVerse() {
            if (!state.selectedVerseKey) return;
            
            const verseElement = document.querySelector(`[data-verse-key="${state.selectedVerseKey}"]`);
            if (verseElement) {
                const verseText = verseElement.querySelector('.verse-text').textContent;
                const [bookId, chapter, verse] = state.selectedVerseKey.split('-');
                const book = [...state.books.old, ...state.books.new].find(b => b.id === bookId);
                
                const textToCopy = `${book?.name || 'Book'} ${chapter}:${verse} - "${verseText}"`;
                
                navigator.clipboard.writeText(textToCopy).then(() => {
                    showToast('Verse copied to clipboard');
                }).catch(() => {
                    showToast('Failed to copy', 'error');
                });
            }
        }

        function shareVerse() {
            if (!state.selectedVerseKey) return;
            
            const verseElement = document.querySelector(`[data-verse-key="${state.selectedVerseKey}"]`);
            if (verseElement) {
                const verseText = verseElement.querySelector('.verse-text').textContent;
                const [bookId, chapter, verse] = state.selectedVerseKey.split('-');
                const book = [...state.books.old, ...state.books.new].find(b => b.id === bookId);
                
                const shareText = `${book?.name || 'Book'} ${chapter}:${verse}\n"${verseText}"`;
                
                if (navigator.share) {
                    navigator.share({
                        title: 'Bible Verse',
                        text: shareText,
                        url: window.location.href
                    }).catch(() => {
                        copyVerse();
                    });
                } else {
                    copyVerse();
                }
            }
        }

        function saveVerseData() {
            if (!state.selectedVerseKey) return;
            
            const note = document.getElementById('verseNote').value.trim();
            if (note) {
                state.notes[state.selectedVerseKey] = note;
            } else {
                delete state.notes[state.selectedVerseKey];
            }
            
            localStorage.setItem('bibleHighlights', JSON.stringify(state.highlights));
            localStorage.setItem('bibleNotes', JSON.stringify(state.notes));
            
            closeModal('verseModal');
            showToast('Changes saved');
        }

        // ========== SCREEN FUNCTIONS ==========
        function openNotebookScreen() {
            const content = document.getElementById('notebookContent');
            const notes = Object.entries(state.notes);
            
            if (notes.length === 0) {
                content.innerHTML = `
                    <div style="text-align: center; padding: 50px 20px; color: var(--accent);">
                        <i class="fas fa-sticky-note" style="font-size: 36px; margin-bottom: 15px;"></i>
                        <h3 style="margin-bottom: 10px;">No Notes Yet</h3>
                        <p>Add notes by long-pressing on verses</p>
                    </div>
                `;
            } else {
                let html = '';
                notes.forEach(([verseKey, note]) => {
                    const [bookId, chapter, verse] = verseKey.split('-');
                    const book = [...state.books.old, ...state.books.new].find(b => b.id === bookId);
                    const verseData = state.highlights[verseKey] || {};
                    
                    // Extract title from note (first line) or use default
                    const lines = note.split('\n');
                    const title = lines[0].length > 50 ? lines[0].substring(0, 50) + '...' : lines[0];
                    const content = lines.slice(1).join('\n') || lines[0];
                    
                    html += `
                        <div class="notebook-page">
                            <div class="note-reference">${book?.name || bookId} ${chapter}:${verse}</div>
                            <div class="note-title">${title}</div>
                            <div class="note-content">${content}</div>
                            <div class="note-date">${new Date().toLocaleDateString()}</div>
                        </div>
                    `;
                });
                
                content.innerHTML = html;
            }
            
            openScreen('notebookScreen');
        }

        function openHighlightsScreen() {
            const content = document.getElementById('highlightsContent');
            const highlights = Object.entries(state.highlights);
            
            if (highlights.length === 0) {
                content.innerHTML = `
                    <div style="text-align: center; padding: 50px 20px; color: var(--accent);">
                        <i class="fas fa-highlighter" style="font-size: 36px; margin-bottom: 15px;"></i>
                        <h3 style="margin-bottom: 10px;">No Highlights Yet</h3>
                        <p>Highlight verses by long-pressing on them</p>
                    </div>
                `;
            } else {
                let html = '';
                highlights.forEach(([verseKey, data]) => {
                    const [bookId, chapter, verse] = verseKey.split('-');
                    const book = [...state.books.old, ...state.books.new].find(b => b.id === bookId);
                    
                    html += `
                        <div class="search-result" onclick="goToSearchResult('${bookId}', ${chapter}, ${verse})">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                <div style="font-weight: bold; color: var(--accent);">
                                    ${book?.name || bookId} ${chapter}:${verse}
                                </div>
                                ${data.highlight ? `<div class="highlight-btn ${data.highlight}" style="width: 20px; height: 20px;"></div>` : ''}
                            </div>
                            ${state.notes[verseKey] ? `<div style="font-size: 14px; color: #555; font-style: italic;">${state.notes[verseKey]}</div>` : ''}
                        </div>
                    `;
                });
                
                content.innerHTML = html;
            }
            
            openScreen('highlightsScreen');
        }

        function openSettingsScreen() {
            openScreen('settingsScreen');
        }

        function openAboutScreen() {
            openScreen('aboutScreen');
        }

        // ========== SEARCH ==========
        function openSearchModal() {
            openModal('searchModal');
            document.getElementById('searchInput').focus();
        }

        let searchTimeout;
        async function performSearch() {
            const query = document.getElementById('searchInput').value.trim();
            const resultsDiv = document.getElementById('searchResults');
            
            if (query.length < 2) {
                resultsDiv.innerHTML = '<div style="text-align: center; padding: 30px; color: #666;">Enter at least 2 characters</div>';
                return;
            }
            
            resultsDiv.innerHTML = '<div style="text-align: center; padding: 30px; color: var(--accent);"><div class="spinner"></div><p>Searching...</p></div>';
            
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                try {
                    const results = searchLocalBibleText(query);
                    displaySearchResults(results);
                } catch (error) {
                    console.error('Search error:', error);
                    resultsDiv.innerHTML = '<div style="text-align: center; padding: 30px; color: var(--accent);"><p>Search failed. Please try again.</p></div>';
                }
            }, 500);
        }

        function searchLocalBibleText(query) {
            const results = [];
            const queryLower = query.toLowerCase();
            
            // Limit search to popular books for performance
            const popularBooks = ['genesis', 'psalms', 'matthew', 'john', 'proverbs'];
            
            popularBooks.forEach(bookId => {
                const book = [...state.books.old, ...state.books.new].find(b => b.id === bookId);
                if (!book || !state.bibleData[bookId]) return;
                
                const chaptersToSearch = Math.min(5, book.chapters);
                for (let chapter = 1; chapter <= chaptersToSearch; chapter++) {
                    const chapterData = state.bibleData[bookId][chapter.toString()];
                    if (!chapterData) continue;
                    
                    // Handle both array and object formats
                    if (Array.isArray(chapterData)) {
                        chapterData.forEach((verseText, verseIndex) => {
                            if (verseText.toLowerCase().includes(queryLower)) {
                                results.push({
                                    book: book.name,
                                    bookId: bookId,
                                    chapter: chapter,
                                    verse: verseIndex + 1,
                                    text: verseText
                                });
                            }
                        });
                    } else if (typeof chapterData === 'object') {
                        Object.keys(chapterData).forEach(verseNumber => {
                            const verseText = chapterData[verseNumber];
                            if (verseText.toLowerCase().includes(queryLower)) {
                                results.push({
                                    book: book.name,
                                    bookId: bookId,
                                    chapter: chapter,
                                    verse: parseInt(verseNumber),
                                    text: verseText
                                });
                            }
                        });
                    }
                    
                    if (results.length >= 50) break;
                }
                if (results.length >= 50) break;
            });
            
            return results.slice(0, 50);
        }

        function displaySearchResults(results) {
            const resultsDiv = document.getElementById('searchResults');
            
            if (results.length === 0) {
                resultsDiv.innerHTML = '<div style="text-align: center; padding: 30px; color: #666;">No results found</div>';
                return;
            }
            
            let html = '';
            results.forEach(result => {
                html += `
                    <div class="search-result" onclick="goToSearchResult('${result.bookId}', ${result.chapter}, ${result.verse})">
                        <div style="font-weight: bold; color: var(--accent); margin-bottom: 5px;">
                            ${result.book} ${result.chapter}:${result.verse}
                        </div>
                        <div style="font-size: 14px; color: #555;">
                            ${highlightText(result.text, document.getElementById('searchInput').value)}
                        </div>
                    </div>
                `;
            });
            
            resultsDiv.innerHTML = html;
        }

        function highlightText(text, query) {
            if (!query) return text;
            const regex = new RegExp(`(${query})`, 'gi');
            return text.replace(regex, '<mark style="background: var(--highlight-yellow); padding: 0 2px;">$1</mark>');
        }

        function goToSearchResult(bookId, chapter, verse) {
            state.currentBook = bookId;
            state.currentBookName = [...state.books.old, ...state.books.new].find(b => b.id === bookId)?.name || bookId;
            state.currentChapter = chapter;
            
            closeModal('searchModal');
            loadChapter().then(() => {
                setTimeout(() => {
                    const verseKey = `${bookId}-${chapter}-${verse}`;
                    const verseElement = document.querySelector(`[data-verse-key="${verseKey}"]`);
                    if (verseElement) {
                        verseElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        verseElement.style.animation = 'none';
                        setTimeout(() => {
                            verseElement.style.animation = 'pulse 1.5s ease';
                        }, 10);
                    }
                }, 100);
            });
        }

        // ========== SETTINGS FUNCTIONS ==========
        function updateFontSize(size) {
            document.querySelectorAll('.verse-text').forEach(el => {
                el.style.fontSize = size + 'px';
            });
            document.getElementById('fontSizeDisplay').textContent = size + 'px';
            
            state.settings.fontSize = size;
            localStorage.setItem('bibleSettings', JSON.stringify(state.settings));
        }

        function updateLineHeight(height) {
            document.querySelectorAll('.verse').forEach(el => {
                el.style.lineHeight = height;
            });
            document.getElementById('lineHeightDisplay').textContent = height;
            
            state.settings.lineHeight = height;
            localStorage.setItem('bibleSettings', JSON.stringify(state.settings));
        }

        function clearCache() {
            if (confirm('Clear all your notes and highlights?')) {
                state.highlights = {};
                state.notes = {};
                localStorage.removeItem('bibleHighlights');
                localStorage.removeItem('bibleNotes');
                showToast('Notes and highlights cleared');
            }
        }

        // ========== UTILITY FUNCTIONS ==========
        function showToast(message, duration = 2000) {
            const toast = document.getElementById('toast');
            document.getElementById('toastMessage').textContent = message;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), duration);
        }

        function selectVerse(verseKey) {
            state.selectedVerseKey = verseKey;
            const verseElement = document.querySelector(`[data-verse-key="${verseKey}"]`);
            if (verseElement) {
                verseElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        }

        function retryLoad() {
            loadChapter();
        }

        // ========== EVENT LISTENERS ==========
        document.getElementById('menuBtn').addEventListener('click', toggleSidebar);
        document.getElementById('searchBtn').addEventListener('click', openSearchModal);
        document.getElementById('currentRef').addEventListener('click', openBookSelection);

        // Close sidebar when clicking outside
        document.addEventListener('click', (e) => {
            const sidebar = document.getElementById('sidebar');
            const menuBtn = document.getElementById('menuBtn');
            
            if (sidebar.classList.contains('active') && 
                !sidebar.contains(e.target) && 
                !menuBtn.contains(e.target)) {
                closeSidebar();
            }
        });

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
            
            switch(e.key) {
                case 'ArrowLeft': prevChapter(); break;
                case 'ArrowRight': nextChapter(); break;
                case 'b': case 'B': openBookSelection(); break;
                case 's': case 'S': openSearchModal(); break;
                case 'm': case 'M': toggleSidebar(); break;
                case 'Escape': 
                    closeAllModals(); 
                    closeSidebar();
                    // Close any open screen
                    document.querySelectorAll('.screen.active').forEach(screen => {
                        closeScreen(screen.id);
                    });
                    break;
            }
        });

        // ========== INITIALIZATION ==========
        window.addEventListener('DOMContentLoaded', () => {
            // Apply saved settings
            if (state.settings.fontSize) {
                document.querySelectorAll('.verse-text').forEach(el => {
                    el.style.fontSize = state.settings.fontSize + 'px';
                });
                document.getElementById('fontSizeSlider').value = state.settings.fontSize;
                document.getElementById('fontSizeDisplay').textContent = state.settings.fontSize + 'px';
            }
            if (state.settings.lineHeight) {
                document.querySelectorAll('.verse').forEach(el => {
                    el.style.lineHeight = state.settings.lineHeight;
                });
                document.getElementById('lineHeightSlider').value = state.settings.lineHeight;
                document.getElementById('lineHeightDisplay').textContent = state.settings.lineHeight;
            }
            
            // Load the Bible data
            loadBibleData();
            
            // Hide navigation hint after 10 seconds
            setTimeout(() => {
                document.getElementById('navHint').style.opacity = '0';
                setTimeout(() => {
                    document.getElementById('navHint').style.display = 'none';
                }, 300);
            }, 10000);
        });
    </script>
</body>
</html>