<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Holy Bible - Offline KJV</title>
    <style>
        :root {
            --parchment: #fff9e6;
            --parchment-dark: #e8d9b5;
            --ink: #3a2c0e;
            --accent: #8b5a2b;
            --border: #d4b483;
            --highlight-yellow: rgba(255, 255, 0, 0.2);
            --highlight-blue: rgba(0, 100, 255, 0.2);
            --highlight-green: rgba(0, 150, 0, 0.2);
            --highlight-pink: rgba(255, 100, 255, 0.2);
            --highlight-purple: rgba(150, 0, 255, 0.2);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Georgia', serif;
            background: #f5f0e6;
            color: #333;
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Header */
        .header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: var(--parchment);
            border-bottom: 2px solid var(--border);
            padding: 10px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 100;
            box-shadow: 0 2px 10px rgba(139, 90, 43, 0.1);
        }

        .menu-btn {
            background: none;
            border: 2px solid var(--border);
            border-radius: 5px;
            width: 40px;
            height: 40px;
            font-size: 18px;
            color: var(--accent);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .title-container {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            flex: 1;
            min-width: 0;
        }

        .title {
            font-family: 'Uncial Antiqua', cursive;
            font-size: 18px;
            font-weight: bold;
            color: var(--accent);
            text-align: center;
            padding: 0 10px;
            cursor: pointer;
        }

        .header-btn {
            background: none;
            border: 2px solid var(--border);
            border-radius: 5px;
            width: 40px;
            height: 40px;
            font-size: 18px;
            color: var(--accent);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Sidebar Menu */
        .sidebar {
            position: fixed;
            top: 0;
            left: -280px;
            width: 280px;
            height: 100%;
            background: var(--parchment);
            border-right: 3px solid var(--border);
            z-index: 1001;
            transition: left 0.3s ease;
            overflow-y: auto;
        }

        .sidebar.active {
            left: 0;
        }

        .sidebar-header {
            padding: 20px;
            background: var(--parchment-dark);
            border-bottom: 2px solid var(--border);
            text-align: center;
        }

        .sidebar-title {
            font-family: 'Uncial Antiqua', cursive;
            color: var(--accent);
            font-size: 24px;
        }

        .menu-items {
            padding: 20px 0;
        }

        .menu-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px 25px;
            color: var(--ink);
            text-decoration: none;
            border-bottom: 1px solid var(--border);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .menu-item:hover {
            background: rgba(139, 90, 43, 0.1);
            padding-left: 30px;
        }

        .menu-item i {
            width: 20px;
            color: var(--accent);
            font-size: 18px;
        }

        /* Main Content */
        .content {
            padding: 70px 20px 70px;
            max-width: 700px;
            margin: 0 auto;
            transition: transform 0.3s ease;
        }

        .content.shifted {
            transform: translateX(280px);
        }

        /* Verse Styling */
        .verse {
            margin-bottom: 20px;
            position: relative;
            padding-left: 45px;
            line-height: 1.8;
            padding: 15px;
            padding-left: 55px;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 8px;
            border-left: 3px solid var(--accent);
            box-shadow: 0 2px 5px rgba(139, 90, 43, 0.1);
        }

        .verse-number {
            position: absolute;
            left: 15px;
            top: 15px;
            font-size: 14px;
            color: var(--accent);
            font-weight: bold;
            background: var(--parchment);
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid var(--border);
        }

        .verse-text {
            display: block;
            font-size: 18px;
            color: var(--ink);
        }

        /* Loading */
        .loading {
            text-align: center;
            padding: 40px 20px;
            color: var(--accent);
        }

        .spinner {
            display: inline-block;
            width: 30px;
            height: 30px;
            border: 3px solid var(--border);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 15px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 10px;
            width: 90%;
            max-width: 400px;
            max-height: 80vh;
            overflow: hidden;
            border: 3px solid var(--border);
        }

        .modal-header {
            background: var(--parchment);
            padding: 15px;
            border-bottom: 2px solid var(--border);
            font-weight: bold;
            color: var(--accent);
            text-align: center;
            font-family: 'Uncial Antiqua', cursive;
            font-size: 20px;
        }

        .modal-body {
            padding: 20px;
            max-height: 60vh;
            overflow-y: auto;
        }

        .modal-close {
            position: absolute;
            right: 15px;
            top: 15px;
            background: none;
            border: none;
            font-size: 20px;
            color: var(--accent);
            cursor: pointer;
        }

        /* Book Selection */
        .testament-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            justify-content: center;
        }

        .tab {
            padding: 8px 15px;
            border: 1px solid var(--border);
            background: white;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
        }

        .tab.active {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
        }

        .book-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
        }

        .book-item {
            padding: 12px 5px;
            text-align: center;
            border: 1px solid var(--border);
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            background: rgba(255, 255, 255, 0.8);
        }

        .book-item:hover {
            background: var(--accent);
            color: white;
        }

        /* Verse Actions Modal */
        .verse-actions {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }

        .action-btn {
            padding: 12px 8px;
            border: 2px solid var(--border);
            background: rgba(255, 255, 255, 0.8);
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
            font-size: 12px;
            color: var(--accent);
        }

        .action-btn:hover {
            background: var(--accent);
            color: white;
        }

        .highlight-options {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 8px;
            margin: 15px 0;
        }

        .highlight-btn {
            width: 35px;
            height: 35px;
            border-radius: 6px;
            border: 2px solid var(--border);
            cursor: pointer;
        }

        .highlight-btn.active {
            transform: scale(1.1);
            box-shadow: 0 3px 8px rgba(0,0,0,0.2);
        }

        .highlight-btn.yellow { background-color: var(--highlight-yellow); }
        .highlight-btn.blue { background-color: var(--highlight-blue); }
        .highlight-btn.green { background-color: var(--highlight-green); }
        .highlight-btn.pink { background-color: var(--highlight-pink); }
        .highlight-btn.purple { background-color: var(--highlight-purple); }

        .note-input {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-family: inherit;
            font-size: 14px;
            resize: vertical;
            min-height: 80px;
            margin-top: 15px;
            background: rgba(255, 255, 255, 0.9);
        }

        /* Toast */
        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: white;
            border: 2px solid var(--accent);
            padding: 10px 20px;
            border-radius: 5px;
            box-shadow: 0 4px 12px rgba(139, 90, 43, 0.2);
            opacity: 0;
            transition: all 0.3s ease;
            z-index: 1001;
        }

        .toast.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }

        /* Navigation Hint */
        .nav-hint {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--parchment);
            border: 2px solid var(--border);
            border-radius: 20px;
            padding: 8px 16px;
            font-size: 12px;
            color: var(--accent);
            z-index: 90;
            opacity: 0.8;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 0.8; }
            50% { opacity: 1; }
        }

        /* Responsive */
        @media (max-width: 600px) {
            .content {
                padding: 70px 15px 70px;
            }
            
            .verse {
                padding: 12px;
                padding-left: 50px;
                font-size: 16px;
            }
            
            .verse-number {
                width: 25px;
                height: 25px;
                font-size: 12px;
            }
            
            .book-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .verse-actions {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Uncial+Antiqua&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <!-- Header -->
    <div class="header">
        <button class="menu-btn" id="menuBtn">
            <i class="fas fa-bars"></i>
        </button>
        <div class="title-container">
            <div class="title" id="currentRef">
                <i class="fas fa-book-bible"></i> Genesis 1
            </div>
        </div>
        <button class="header-btn" id="searchBtn">
            <i class="fas fa-search"></i>
        </button>
    </div>

    <!-- Sidebar Menu -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <div class="sidebar-title">
                <i class="fas fa-bible"></i> Holy Bible
            </div>
        </div>
        <div class="menu-items">
            <div class="menu-item" onclick="openBookModal()">
                <i class="fas fa-book-open"></i>
                <span>Books</span>
            </div>
            <div class="menu-item" onclick="openNotebook()">
                <i class="fas fa-book"></i>
                <span>Notebook</span>
            </div>
            <div class="menu-item" onclick="openHighlights()">
                <i class="fas fa-highlighter"></i>
                <span>Highlights</span>
            </div>
            <div class="menu-item" onclick="openSettings()">
                <i class="fas fa-cog"></i>
                <span>Settings</span>
            </div>
            <div class="menu-item" onclick="openAbout()">
                <i class="fas fa-info-circle"></i>
                <span>About</span>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="content">
        <div id="bibleContent">
            <div class="loading">
                <div class="spinner"></div>
                <p>Loading Bible...</p>
            </div>
        </div>
    </div>

    <!-- Navigation Hint -->
    <div class="nav-hint" id="navHint">
        <i class="fas fa-arrows-left-right"></i> Swipe left/right to navigate chapters
    </div>

    <!-- Book Selection Modal -->
    <div class="modal" id="bookModal">
        <div class="modal-content">
            <div class="modal-header">
                <span><i class="fas fa-book-open"></i> Select Book</span>
                <button class="modal-close" onclick="closeModal('bookModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="testament-tabs">
                    <div class="tab active" onclick="filterBooks('all')">All</div>
                    <div class="tab" onclick="filterBooks('old')">Old</div>
                    <div class="tab" onclick="filterBooks('new')">New</div>
                </div>
                <div class="book-grid" id="bookList">
                    <!-- Books will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Chapter Selection Modal -->
    <div class="modal" id="chapterModal">
        <div class="modal-content">
            <div class="modal-header">
                <span id="chapterTitle"><i class="fas fa-list-ol"></i> Select Chapter</span>
                <button class="modal-close" onclick="closeModal('chapterModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="book-grid" id="chapterList">
                    <!-- Chapters will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Verse Actions Modal -->
    <div class="modal" id="verseModal">
        <div class="modal-content">
            <div class="modal-header">
                <span id="verseTitle"><i class="fas fa-edit"></i> Verse Options</span>
                <button class="modal-close" onclick="closeModal('verseModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="verse-actions">
                    <button class="action-btn" onclick="addNote()">
                        <i class="fas fa-sticky-note"></i>
                        <span>Note</span>
                    </button>
                    <button class="action-btn" onclick="toggleUnderline()">
                        <i class="fas fa-underline"></i>
                        <span>Underline</span>
                    </button>
                    <button class="action-btn" onclick="toggleItalic()">
                        <i class="fas fa-italic"></i>
                        <span>Italic</span>
                    </button>
                    <button class="action-btn" onclick="toggleBold()">
                        <i class="fas fa-bold"></i>
                        <span>Bold</span>
                    </button>
                    <button class="action-btn" onclick="copyVerse()">
                        <i class="fas fa-copy"></i>
                        <span>Copy</span>
                    </button>
                    <button class="action-btn" onclick="shareVerse()">
                        <i class="fas fa-share"></i>
                        <span>Share</span>
                    </button>
                </div>
                
                <div style="margin: 15px 0;">
                    <div style="font-weight: bold; color: var(--accent); margin-bottom: 8px;">Highlight:</div>
                    <div class="highlight-options">
                        <div class="highlight-btn yellow" onclick="applyHighlight('yellow')"></div>
                        <div class="highlight-btn blue" onclick="applyHighlight('blue')"></div>
                        <div class="highlight-btn green" onclick="applyHighlight('green')"></div>
                        <div class="highlight-btn pink" onclick="applyHighlight('pink')"></div>
                        <div class="highlight-btn purple" onclick="applyHighlight('purple')"></div>
                    </div>
                </div>
                
                <textarea class="note-input" id="verseNote" placeholder="Add a note for this verse..."></textarea>
                <button class="action-btn" style="width: 100%; padding: 15px; margin-top: 15px;" onclick="saveVerseData()">
                    <i class="fas fa-save"></i> Save Changes
                </button>
            </div>
        </div>
    </div>

    <!-- Toast -->
    <div class="toast" id="toast">
        <i class="fas fa-check-circle"></i>
        <span id="toastMessage">Action completed</span>
    </div>

    <script>
        // ========== STATE MANAGEMENT ==========
        const state = {
            currentBookIndex: 0, // Index in the bibleData array
            currentBookName: 'Genesis',
            currentChapter: 1,
            selectedVerseKey: null,
            isLoading: false,
            bibleData: null, // Will hold the loaded Bible data
            highlights: JSON.parse(localStorage.getItem('bibleHighlights') || '{}'),
            notes: JSON.parse(localStorage.getItem('bibleNotes') || '{}'),
            settings: JSON.parse(localStorage.getItem('bibleSettings') || '{}'),
            bookNames: [
                "Genesis", "Exodus", "Leviticus", "Numbers", "Deuteronomy", "Joshua", 
                "Judges", "Ruth", "1 Samuel", "2 Samuel", "1 Kings", "2 Kings", 
                "1 Chronicles", "2 Chronicles", "Ezra", "Nehemiah", "Esther", "Job", 
                "Psalms", "Proverbs", "Ecclesiastes", "Song of Solomon", "Isaiah", 
                "Jeremiah", "Lamentations", "Ezekiel", "Daniel", "Hosea", "Joel", 
                "Amos", "Obadiah", "Jonah", "Micah", "Nahum", "Habakkuk", "Zephaniah", 
                "Haggai", "Zechariah", "Malachi", "Matthew", "Mark", "Luke", "John", 
                "Acts", "Romans", "1 Corinthians", "2 Corinthians", "Galatians", 
                "Ephesians", "Philippians", "Colossians", "1 Thessalonians", 
                "2 Thessalonians", "1 Timothy", "2 Timothy", "Titus", "Philemon", 
                "Hebrews", "James", "1 Peter", "2 Peter", "1 John", "2 John", 
                "3 John", "Jude", "Revelation"
            ]
        };

        // ========== BIBLE DATA LOADING ==========
        async function loadBibleData() {
            try {
                console.log('Loading Bible data...');
                const response = await fetch('bible.json');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                state.bibleData = await response.json();
                console.log('Bible data loaded successfully. Books found:', state.bibleData.length);
                
                // Initialize books list for UI
                initializeBooks();
                
                // Load the first chapter
                loadChapter(0, 1);
                
            } catch (error) {
                console.error('Error loading Bible data:', error);
                document.getElementById('bibleContent').innerHTML = `
                    <div class="loading">
                        <div style="color: #dc2626; margin-bottom: 10px;">⚠️</div>
                        <h3 style="color: var(--accent); margin-bottom: 10px;">Error Loading Bible</h3>
                        <p>Failed to load bible.json file. Please ensure:</p>
                        <ol style="text-align: left; margin: 10px 20px; font-size: 14px;">
                            <li>bible.json is in the same directory as this HTML file</li>
                            <li>The file contains valid JSON data</li>
                            <li>Check browser console for detailed error</li>
                        </ol>
                        <button class="action-btn" onclick="loadBibleData()" style="margin-top: 10px; padding: 10px;">
                            <i class="fas fa-redo"></i> Retry
                        </button>
                    </div>
                `;
            }
        }

        function initializeBooks() {
            // Create book mapping with proper names
            state.books = {
                old: state.bookNames.slice(0, 39).map((name, index) => ({
                    id: index,
                    name: name,
                    chapters: state.bibleData[index].chapters.length
                })),
                new: state.bookNames.slice(39).map((name, index) => ({
                    id: index + 39,
                    name: name,
                    chapters: state.bibleData[index + 39].chapters.length
                }))
            };
        }

        // ========== CHAPTER LOADING ==========
        function loadChapter(bookIndex, chapter) {
            if (state.isLoading) return;
            
            state.isLoading = true;
            
            if (bookIndex !== undefined && chapter !== undefined) {
                state.currentBookIndex = bookIndex;
                state.currentChapter = chapter;
                state.currentBookName = state.bookNames[bookIndex];
            }
            
            document.getElementById('currentRef').innerHTML = 
                `<i class="fas fa-book-bible"></i> ${state.currentBookName} ${state.currentChapter}`;
            
            try {
                if (!state.bibleData) {
                    throw new Error('Bible data not loaded');
                }
                
                const bookData = state.bibleData[state.currentBookIndex];
                if (!bookData) {
                    throw new Error(`Book ${state.currentBookIndex} not found in data`);
                }
                
                const chapterData = bookData.chapters[state.currentChapter - 1];
                if (!chapterData) {
                    throw new Error(`Chapter ${state.currentChapter} not found`);
                }
                
                // Display the verses
                displayVerses(chapterData);
                showToast(`Loaded ${state.currentBookName} ${state.currentChapter}`);
                
            } catch (error) {
                console.error('Failed to load chapter:', error);
                document.getElementById('bibleContent').innerHTML = `
                    <div class="loading">
                        <div style="color: #dc2626; margin-bottom: 10px;">⚠️</div>
                        <p>Failed to load chapter</p>
                        <p style="font-size: 14px; color: #666;">${error.message}</p>
                        <button class="action-btn" onclick="retryLoad()" style="margin-top: 10px; padding: 10px;">
                            Retry
                        </button>
                    </div>
                `;
                showToast('Failed to load chapter', 3000);
            } finally {
                state.isLoading = false;
            }
        }

        function displayVerses(verses) {
            let html = '';
            
            verses.forEach((verseText, index) => {
                const verseNumber = index + 1;
                const verseKey = `${state.currentBookIndex}-${state.currentChapter}-${verseNumber}`;
                const verseData = state.highlights[verseKey] || {};
                const note = state.notes[verseKey] || '';
                
                let verseClasses = 'verse';
                if (verseData.highlight) verseClasses += ` highlight-${verseData.highlight}`;
                if (verseData.underline) verseClasses += ' underlined';
                if (verseData.italic) verseClasses += ' italicized';
                if (verseData.bold) verseClasses += ' bold';
                
                html += `
                    <div class="${verseClasses}" 
                         data-verse-key="${verseKey}"
                         onclick="selectVerse('${verseKey}')"
                         oncontextmenu="event.preventDefault(); openVerseActions('${verseKey}')"
                         ontouchstart="startTouch('${verseKey}')"
                         ontouchend="endTouch('${verseKey}')">
                        <span class="verse-number">${verseNumber}</span>
                        <span class="verse-text">${verseText}</span>
                        ${note ? `<div style="margin-top: 8px; font-style: italic; color: #666; font-size: 14px;">${note}</div>` : ''}
                    </div>
                `;
            });
            
            document.getElementById('bibleContent').innerHTML = html;
        }

        // ========== TOUCH HANDLING ==========
        let touchTimer;
        let longPressDetected = false;

        function startTouch(verseKey) {
            longPressDetected = false;
            touchTimer = setTimeout(() => {
                longPressDetected = true;
                openVerseActions(verseKey);
            }, 500);
        }

        function endTouch(verseKey) {
            clearTimeout(touchTimer);
            if (!longPressDetected) {
                selectVerse(verseKey);
            }
        }

        // ========== SWIPE NAVIGATION ==========
        let touchStartX = 0;
        let touchStartY = 0;

        document.addEventListener('touchstart', (e) => {
            touchStartX = e.changedTouches[0].screenX;
            touchStartY = e.changedTouches[0].screenY;
        });

        document.addEventListener('touchend', (e) => {
            const touchEndX = e.changedTouches[0].screenX;
            const touchEndY = e.changedTouches[0].screenY;
            const diffX = touchStartX - touchEndX;
            const diffY = Math.abs(touchStartY - touchEndY);
            
            // Only trigger if horizontal swipe is significant and vertical movement is minimal
            if (Math.abs(diffX) > 50 && diffY < 100) {
                if (diffX > 0) {
                    nextChapter();
                } else if (diffX < 0) {
                    prevChapter();
                }
            }
        });

        // ========== NAVIGATION FUNCTIONS ==========
        function prevChapter() {
            if (state.currentChapter > 1) {
                loadChapter(state.currentBookIndex, state.currentChapter - 1);
            }
        }

        function nextChapter() {
            const bookData = state.bibleData[state.currentBookIndex];
            if (bookData && state.currentChapter < bookData.chapters.length) {
                loadChapter(state.currentBookIndex, state.currentChapter + 1);
            }
        }

        // ========== MODAL MANAGEMENT ==========
        function openModal(modalId) {
            closeSidebar();
            closeAllModals();
            document.getElementById(modalId).classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
            document.body.style.overflow = 'auto';
        }

        function closeAllModals() {
            document.querySelectorAll('.modal').forEach(modal => {
                modal.classList.remove('active');
            });
            document.body.style.overflow = 'auto';
        }

        // ========== SIDEBAR ==========
        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('active');
        }

        function closeSidebar() {
            document.getElementById('sidebar').classList.remove('active');
        }

        // ========== BOOK SELECTION ==========
        function openBookModal() {
            filterBooks('all');
            openModal('bookModal');
        }

        function filterBooks(filter) {
            const bookList = document.getElementById('bookList');
            const tabs = document.querySelectorAll('.tab');
            
            tabs.forEach(tab => tab.classList.remove('active'));
            event.target.classList.add('active');
            
            let booksToShow = [];
            if (filter === 'old') {
                booksToShow = state.books.old;
            } else if (filter === 'new') {
                booksToShow = state.books.new;
            } else {
                booksToShow = [...state.books.old, ...state.books.new];
            }
            
            bookList.innerHTML = '';
            booksToShow.forEach(book => {
                const bookItem = document.createElement('div');
                bookItem.className = 'book-item';
                bookItem.textContent = book.name;
                bookItem.onclick = () => {
                    state.currentBookIndex = book.id;
                    state.currentBookName = book.name;
                    closeModal('bookModal');
                    setTimeout(() => openChapterModal(), 300);
                };
                bookList.appendChild(bookItem);
            });
        }

        function openChapterModal() {
            const currentBook = [...state.books.old, ...state.books.new]
                .find(b => b.id === state.currentBookIndex);
            if (!currentBook) return;
            
            document.getElementById('chapterTitle').innerHTML = 
                `<i class="fas fa-list-ol"></i> ${state.currentBookName}`;
            
            const chapterList = document.getElementById('chapterList');
            chapterList.innerHTML = '';
            
            const chapters = currentBook.chapters;
            const columns = Math.ceil(Math.sqrt(chapters));
            chapterList.style.gridTemplateColumns = `repeat(${columns}, 1fr)`;
            
            for (let i = 1; i <= chapters; i++) {
                const chapterItem = document.createElement('div');
                chapterItem.className = 'book-item';
                chapterItem.textContent = i;
                chapterItem.onclick = () => {
                    state.currentChapter = i;
                    closeModal('chapterModal');
                    loadChapter();
                };
                chapterList.appendChild(chapterItem);
            }
            
            openModal('chapterModal');
        }

        // ========== VERSE ACTIONS ==========
        function openVerseActions(verseKey) {
            state.selectedVerseKey = verseKey;
            const verseData = state.highlights[verseKey] || {};
            const note = state.notes[verseKey] || '';
            
            const [bookIndex, chapter, verse] = verseKey.split('-');
            const bookName = state.bookNames[bookIndex];
            document.getElementById('verseTitle').innerHTML = 
                `<i class="fas fa-edit"></i> ${bookName} ${chapter}:${verse}`;
            
            document.getElementById('verseNote').value = note;
            
            document.querySelectorAll('.highlight-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.classList.contains(verseData.highlight)) {
                    btn.classList.add('active');
                }
            });
            
            openModal('verseModal');
        }

        function applyHighlight(color) {
            if (!state.selectedVerseKey) return;
            
            const verseData = state.highlights[state.selectedVerseKey] || {};
            verseData.highlight = color;
            state.highlights[state.selectedVerseKey] = verseData;
            
            document.querySelectorAll('.highlight-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.classList.contains(color)) btn.classList.add('active');
            });
            
            const verseElement = document.querySelector(`[data-verse-key="${state.selectedVerseKey}"]`);
            if (verseElement) {
                verseElement.classList.remove('highlight-yellow', 'highlight-blue', 'highlight-green', 'highlight-pink', 'highlight-purple');
                verseElement.classList.add(`highlight-${color}`);
            }
            
            showToast(`Highlighted in ${color}`);
        }

        function toggleUnderline() {
            if (!state.selectedVerseKey) return;
            
            const verseData = state.highlights[state.selectedVerseKey] || {};
            verseData.underline = !verseData.underline;
            state.highlights[state.selectedVerseKey] = verseData;
            
            const verseElement = document.querySelector(`[data-verse-key="${state.selectedVerseKey}"]`);
            if (verseElement) verseElement.classList.toggle('underlined');
            
            showToast(verseData.underline ? 'Underlined' : 'Underline removed');
        }

        function toggleItalic() {
            if (!state.selectedVerseKey) return;
            
            const verseData = state.highlights[state.selectedVerseKey] || {};
            verseData.italic = !verseData.italic;
            state.highlights[state.selectedVerseKey] = verseData;
            
            const verseElement = document.querySelector(`[data-verse-key="${state.selectedVerseKey}"]`);
            if (verseElement) verseElement.classList.toggle('italicized');
            
            showToast(verseData.italic ? 'Italicized' : 'Italic removed');
        }

        function toggleBold() {
            if (!state.selectedVerseKey) return;
            
            const verseData = state.highlights[state.selectedVerseKey] || {};
            verseData.bold = !verseData.bold;
            state.highlights[state.selectedVerseKey] = verseData;
            
            const verseElement = document.querySelector(`[data-verse-key="${state.selectedVerseKey}"]`);
            if (verseElement) verseElement.classList.toggle('bold');
            
            showToast(verseData.bold ? 'Bold applied' : 'Bold removed');
        }

        function addNote() {
            document.getElementById('verseNote').focus();
        }

        function copyVerse() {
            if (!state.selectedVerseKey) return;
            
            const verseElement = document.querySelector(`[data-verse-key="${state.selectedVerseKey}"]`);
            if (verseElement) {
                const verseText = verseElement.querySelector('.verse-text').textContent;
                const [bookIndex, chapter, verse] = state.selectedVerseKey.split('-');
                const bookName = state.bookNames[bookIndex];
                
                const textToCopy = `${bookName} ${chapter}:${verse} - "${verseText}"`;
                
                navigator.clipboard.writeText(textToCopy).then(() => {
                    showToast('Verse copied to clipboard');
                }).catch(() => {
                    showToast('Failed to copy', 'error');
                });
            }
        }

        function shareVerse() {
            if (!state.selectedVerseKey) return;
            
            const verseElement = document.querySelector(`[data-verse-key="${state.selectedVerseKey}"]`);
            if (verseElement) {
                const verseText = verseElement.querySelector('.verse-text').textContent;
                const [bookIndex, chapter, verse] = state.selectedVerseKey.split('-');
                const bookName = state.bookNames[bookIndex];
                
                const shareText = `${bookName} ${chapter}:${verse}\n"${verseText}"`;
                
                if (navigator.share) {
                    navigator.share({
                        title: 'Bible Verse',
                        text: shareText,
                        url: window.location.href
                    }).catch(() => {
                        copyVerse();
                    });
                } else {
                    copyVerse();
                }
            }
        }

        function saveVerseData() {
            if (!state.selectedVerseKey) return;
            
            const note = document.getElementById('verseNote').value.trim();
            if (note) {
                state.notes[state.selectedVerseKey] = note;
            } else {
                delete state.notes[state.selectedVerseKey];
            }
            
            localStorage.setItem('bibleHighlights', JSON.stringify(state.highlights));
            localStorage.setItem('bibleNotes', JSON.stringify(state.notes));
            
            closeModal('verseModal');
            showToast('Changes saved');
        }

        // ========== MENU FUNCTIONS ==========
        function openNotebook() {
            const notes = Object.entries(state.notes);
            
            if (notes.length === 0) {
                alert('No notes yet. Add notes by long-pressing on verses.');
            } else {
                let notebookContent = 'MY NOTEBOOK\n\n';
                notes.forEach(([verseKey, note]) => {
                    const [bookIndex, chapter, verse] = verseKey.split('-');
                    const bookName = state.bookNames[bookIndex];
                    notebookContent += `${bookName} ${chapter}:${verse}\n${note}\n\n`;
                });
                
                alert(notebookContent);
            }
        }

        function openHighlights() {
            const highlights = Object.entries(state.highlights);
            
            if (highlights.length === 0) {
                alert('No highlights yet. Highlight verses by long-pressing on them.');
            } else {
                let highlightsContent = 'MY HIGHLIGHTS\n\n';
                highlights.forEach(([verseKey, data]) => {
                    const [bookIndex, chapter, verse] = verseKey.split('-');
                    const bookName = state.bookNames[bookIndex];
                    highlightsContent += `${bookName} ${chapter}:${verse} - Highlight: ${data.highlight || 'none'}\n`;
                });
                
                alert(highlightsContent);
            }
        }

        function openSettings() {
            alert('Settings will be implemented in the next version.');
        }

        function openAbout() {
            alert('Holy Bible Reader - Offline KJV Version\n\nWorks completely offline using local JSON data.');
        }

        // ========== UTILITY FUNCTIONS ==========
        function showToast(message, duration = 2000) {
            const toast = document.getElementById('toast');
            document.getElementById('toastMessage').textContent = message;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), duration);
        }

        function selectVerse(verseKey) {
            state.selectedVerseKey = verseKey;
            const verseElement = document.querySelector(`[data-verse-key="${verseKey}"]`);
            if (verseElement) {
                verseElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        }

        function retryLoad() {
            loadChapter();
        }

        // ========== EVENT LISTENERS ==========
        document.getElementById('menuBtn').addEventListener('click', toggleSidebar);
        document.getElementById('searchBtn').addEventListener('click', () => {
            alert('Search feature will be implemented in the next version.');
        });
        document.getElementById('currentRef').addEventListener('click', openBookModal);

        // Close sidebar when clicking outside
        document.addEventListener('click', (e) => {
            const sidebar = document.getElementById('sidebar');
            const menuBtn = document.getElementById('menuBtn');
            
            if (sidebar.classList.contains('active') && 
                !sidebar.contains(e.target) && 
                !menuBtn.contains(e.target)) {
                closeSidebar();
            }
        });

        // Close modals when clicking outside
        document.querySelectorAll('.modal').forEach(modal => {
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    closeModal(modal.id);
                }
            });
        });

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
            
            switch(e.key) {
                case 'ArrowLeft': prevChapter(); break;
                case 'ArrowRight': nextChapter(); break;
                case 'b': case 'B': openBookModal(); break;
                case 'm': case 'M': toggleSidebar(); break;
                case 'Escape': closeAllModals(); closeSidebar(); break;
            }
        });

        // ========== INITIALIZATION ==========
        window.addEventListener('DOMContentLoaded', () => {
            // Apply saved settings
            if (state.settings.fontSize) {
                document.querySelectorAll('.verse-text').forEach(el => {
                    el.style.fontSize = state.settings.fontSize + 'px';
                });
            }
            if (state.settings.lineHeight) {
                document.querySelectorAll('.verse').forEach(el => {
                    el.style.lineHeight = state.settings.lineHeight;
                });
            }
            
            // Load the Bible data
            loadBibleData();
            
            // Hide navigation hint after 10 seconds
            setTimeout(() => {
                const navHint = document.getElementById('navHint');
                if (navHint) {
                    navHint.style.opacity = '0';
                    setTimeout(() => {
                        navHint.style.display = 'none';
                    }, 300);
                }
            }, 10000);
        });
    </script>
</body>
</html>
